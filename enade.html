<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz ENADE - Artes Visuais</title>

    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://cdn.tailwindcss.com; object-src 'none'; base-uri 'self';">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .screen { display: none; }
        .active-screen { display: flex; }
        .theme-tag {
            transition: all 0.2s ease-in-out;
        }
        .theme-tag.selected {
            background-color: #10B981; /* green-500 */
            color: white;
            transform: scale(1.05);
        }
        .option-btn.correct {
            background-color: #10B981 !important; /* green-500 */
            color: white !important;
            border-color: #059669 !important;
        }
        .option-btn.incorrect {
            background-color: #EF4444 !important; /* red-500 */
            color: white !important;
            border-color: #DC2626 !important;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <div class="container mx-auto p-4 max-w-2xl w-full">
        <div id="app-container" class="bg-white rounded-xl shadow-lg overflow-hidden">

            <div id="login-screen" class="screen p-8 md:p-12 flex-col items-center justify-center space-y-6">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center">Quiz ENADE</h1>
                <p class="text-center text-gray-600">Artes Visuais</p>
                <form id="login-form" class="w-full max-w-sm space-y-4">
                    <input type="email" id="login-email" placeholder="Email Institucional" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="password" id="login-password" placeholder="Senha" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Entrar</button>
                    <!-- Bot√£o para "Esqueceu a Senha?" -->
                    <button type="button" id="forgot-password-btn" class="w-full text-blue-600 font-semibold hover:underline mt-2">Esqueceu a senha?</button>
                </form>
                <p class="text-gray-600">N√£o tem uma conta? <button id="go-to-register-btn" class="text-blue-600 font-semibold hover:underline">Registrar</button></p>
            </div>

            <div id="register-screen" class="screen p-8 md:p-12 flex-col items-center justify-center space-y-6">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 text-center">Criar Conta</h2>
                <form id="register-form" class="w-full max-w-sm space-y-4">
                    <input type="text" id="register-name" placeholder="Nome Completo" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <input type="email" id="register-email" placeholder="Email Institucional" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <!-- Campos de senha adicionados -->
                    <input type="password" id="register-password" placeholder="Definir Senha (m√≠n. 6 caracteres)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required minlength="6">
                    <input type="password" id="register-confirm-password" placeholder="Confirmar Senha" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required minlength="6">
                    <button type="submit" class="w-full bg-green-500 text-white p-3 rounded-lg font-semibold hover:bg-green-600 transition-colors">Registrar</button>
                </form>
                <p class="text-gray-600">J√° tem uma conta? <button id="go-to-login-btn" class="text-blue-600 font-semibold hover:underline">Fazer Login</button></p>
            </div>

            <!-- Nova tela para redefinir senha -->
            <div id="forgot-password-screen" class="screen p-8 md:p-12 flex-col items-center justify-center space-y-6">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-800 text-center">Redefinir Senha</h2>
                <p class="text-center text-gray-600">Informe seu email institucional para redefinir sua senha.</p>
                <form id="forgot-password-form" class="w-full max-w-sm space-y-4">
                    <input type="email" id="forgot-email" placeholder="Email Institucional" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Enviar Link de Redefini√ß√£o</button>
                </form>
                <button id="back-to-login-from-forgot-btn" class="text-blue-600 font-semibold hover:underline">Voltar ao Login</button>
            </div>

            <div id="setup-screen" class="screen p-8 md:p-12 flex-col space-y-8">
                 <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Ol√°, <span id="user-name-display"></span>!</h2>
                        <p class="text-gray-600">Vamos come√ßar?</p>
                    </div>
                    <div class="flex space-x-2">
                        <button id="view-ranking-btn-setup" class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-yellow-600 transition-colors">Ver Ranking</button>
                        <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600 transition-colors">Sair</button>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">1. Escolha os temas</h3>
                    <p class="text-sm text-gray-500 mb-2">Selecione um ou mais temas. Se nenhum for escolhido, todas as quest√µes ser√£o consideradas.</p>
                    <div id="themes-container" class="flex flex-wrap gap-2">
                        </div>
                    <p id="question-count-display" class="text-sm text-gray-600 mt-4 text-center font-medium"></p>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">2. Escolha o tamanho do Quiz</h3>
                    <div id="quiz-size-container" class="flex flex-col sm:flex-row gap-4">
                        <button data-size="3" class="quiz-size-btn flex-1 p-4 border-2 border-gray-300 rounded-lg text-lg font-semibold text-gray-700 hover:border-blue-500 hover:bg-blue-50 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:hover:border-gray-300">3 Quest√µes</button>
                        <button data-size="6" class="quiz-size-btn flex-1 p-4 border-2 border-gray-300 rounded-lg text-lg font-semibold text-gray-700 hover:border-blue-500 hover:bg-blue-50 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:hover:border-gray-300">6 Quest√µes</button>
                    </div>
                    <div id="quiz-rules-notification" class="mt-4 p-3 bg-blue-50 text-blue-800 rounded-lg text-center text-sm hidden"></div>
                </div>

                <button id="start-quiz-btn" class="w-full bg-blue-600 text-white p-4 rounded-lg text-xl font-bold hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Iniciar Quiz</button>
            </div>

            <div id="quiz-screen" class="screen p-6 md:p-8 flex-col">
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-sm font-medium text-gray-600 mb-6">
                    <span id="question-counter"></span>
                    <span id="current-score">Pontos: 0</span>
                </div>
                <div id="question-container" class="space-y-4 flex-grow">
                    <div id="question-theme-container" class="flex flex-wrap gap-2 mb-2"></div>
                    <img id="question-image" src="" alt="Imagem da quest√£o" class="max-w-full h-auto mx-auto rounded-lg shadow-md hidden">
                    <h3 id="question-enunciado" class="text-lg md:text-xl font-medium text-gray-800 leading-relaxed"></h3>
                    <div id="options-container" class="grid grid-cols-1 gap-3">
                        </div>
                </div>
                 <button id="next-question-btn" class="mt-6 w-full bg-green-500 text-white p-3 rounded-lg font-semibold hover:bg-green-600 transition-colors hidden">Pr√≥xima Quest√£o</button>
            </div>

            <div id="results-screen" class="screen p-8 md:p-12 flex-col items-center justify-center space-y-6 text-center">
                 <h2 class="text-3xl font-bold text-gray-800">Quiz Finalizado!</h2>
                 <div id="results-icon" class="text-7xl"></div>
                 <p id="results-summary" class="text-xl text-gray-700"></p>
                 <p id="results-bonus" class="text-lg font-semibold text-green-600"></p>
                 <p id="results-total-score" class="text-2xl font-bold text-blue-600"></p>
                 <div class="flex flex-col sm:flex-row gap-4 w-full max-w-sm mt-6">
                     <button id="play-again-btn" class="flex-1 bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Jogar Novamente</button>
                     <button id="view-ranking-btn-results" class="flex-1 bg-yellow-500 text-white p-3 rounded-lg font-semibold hover:bg-yellow-600 transition-colors">Ver Ranking</button>
                 </div>
            </div>

            <div id="ranking-screen" class="screen p-8 md:p-12 flex-col space-y-6">
                <h2 class="text-3xl font-bold text-gray-800 text-center mb-4">Ranking de Alunos</h2>
                <div class="w-full bg-white rounded-lg border">
                    <div class="grid grid-cols-12 gap-4 p-3 border-b bg-gray-50 font-bold text-gray-600">
                        <div class="col-span-1">#</div>
                        <div class="col-span-7">Nome</div>
                        <div class="col-span-4 text-right">Pontua√ß√£o</div>
                    </div>
                    <div id="ranking-list" class="divide-y">
                        </div>
                </div>
                <button id="back-to-setup-btn" class="w-full max-w-sm mx-auto bg-gray-600 text-white p-3 rounded-lg font-semibold hover:bg-gray-700 transition-colors">Voltar</button>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center space-y-4">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800"></h3>
            <p id="modal-message" class="text-gray-600"></p>
            <button id="modal-close-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">OK</button>
        </div>
    </div>

    <script src="perguntas.js"></script>
    <script src="firebase-config.js"></script>

    <script type="module">
        // Importa√ß√µes do Firebase Authentication
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged,
                 createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = window.firebaseConfig || {};
        const appId = window.appId || 'default-quiz-app';

        if (!firebaseConfig.apiKey) {
            showModal("Erro", "Erro: Configura√ß√£o do Firebase n√£o encontrada.");
            hideLoading();
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Caminho da cole√ß√£o de usu√°rios no Firestore.
        // Cada documento nesta cole√ß√£o ter√° o UID do Firebase Auth como seu ID.
        const usersCollectionPath = `/artifacts/${appId}/public/data/users`;
        const usersCollection = collection(db, usersCollectionPath);

        let allQuestions = [];
        let uniqueThemes = [];
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let correctAnswersCount = 0;
        let quizSize = 0;
        let currentUserData = null; // Renomeado para evitar conflito com 'user' do Firebase Auth

        const screens = {
            login: document.getElementById('login-screen'),
            register: document.getElementById('register-screen'),
            forgotPassword: document.getElementById('forgot-password-screen'),
            setup: document.getElementById('setup-screen'),
            quiz: document.getElementById('quiz-screen'),
            results: document.getElementById('results-screen'),
            ranking: document.getElementById('ranking-screen'),
        };

        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const loadingSpinner = document.getElementById('loading-spinner');

        const showScreen = (screenName) => {
            Object.values(screens).forEach(screen => screen.classList.remove('active-screen'));
            if(screens[screenName]) {
                screens[screenName].classList.add('active-screen');
            }
        };

        const showModal = (title, message) => {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            modal.style.display = 'flex';
        };

        const hideModal = () => {
            modal.style.display = 'none';
        };

        const showLoading = () => loadingSpinner.style.display = 'flex';
        const hideLoading = () => loadingSpinner.style.display = 'none';

        const updateAvailableQuestionsCount = () => {
            const questionCountDisplay = document.getElementById('question-count-display');
            const selectedThemeElements = document.querySelectorAll('.theme-tag.selected');
            const selectedThemes = Array.from(selectedThemeElements).map(el => el.dataset.theme);

            let filteredQuestions = allQuestions;
            if (selectedThemes.length > 0) {
                filteredQuestions = allQuestions.filter(q =>
                    selectedThemes.some(selectedTheme => q.tema.includes(selectedTheme))
                );
            }

            const count = filteredQuestions.length;
            questionCountDisplay.textContent = `${count} quest√µes dispon√≠veis com os temas selecionados.`;

            document.querySelectorAll('.quiz-size-btn').forEach(btn => {
                const size = parseInt(btn.dataset.size);
                btn.disabled = count < size;
            });

            const selectedSizeBtn = document.querySelector('.quiz-size-btn.border-blue-500');
            if (selectedSizeBtn && selectedSizeBtn.disabled) {
                selectedSizeBtn.classList.remove('border-blue-500', 'bg-blue-50', 'ring-2');
                quizSize = 0;
                document.getElementById('start-quiz-btn').disabled = true;
                document.getElementById('quiz-rules-notification').classList.add('hidden');
            } else if (selectedSizeBtn) {
                document.getElementById('start-quiz-btn').disabled = false;
            } else {
                document.getElementById('start-quiz-btn').disabled = true;
            }
        };

        const fetchQuestions = () => {
            if (typeof perguntasLocais === 'undefined') {
                console.error("Erro Fatal: 'perguntas.js' n√£o foi carregado.");
                showModal('Erro Cr√≠tico', "O ficheiro de perguntas ('perguntas.js') n√£o foi encontrado ou carregado corretamente.");
                hideLoading();
                return;
            }

            try {
                allQuestions = perguntasLocais
                    .filter(q => q.enunciado && q.resposta_correta && q.tema)
                    .map(q => {
                        const themes = (typeof q.tema === 'string')
                            ? q.tema.split(',').map(t => t.trim())
                            : q.tema;
                        return { ...q, tema: themes.filter(Boolean) };
                    });

                const allThemes = allQuestions.flatMap(q => q.tema);
                uniqueThemes = [...new Set(allThemes)].filter(Boolean).sort();
                populateThemes();
                updateAvailableQuestionsCount();
            } catch (err) {
                 console.error("Erro ao processar 'perguntas.js':", err);
                 showModal('Erro Cr√≠tico', 'Verifique a sintaxe do seu ficheiro `perguntas.js`.');
                 hideLoading();
            }
        };

        const populateThemes = () => {
            const container = document.getElementById('themes-container');
            container.innerHTML = '';
            uniqueThemes.forEach(theme => {
                const button = document.createElement('button');
                button.className = 'theme-tag px-3 py-1.5 border border-gray-300 rounded-full text-sm font-medium text-gray-600 hover:bg-gray-100';
                button.textContent = theme;
                button.dataset.theme = theme;
                button.addEventListener('click', () => {
                    button.classList.toggle('selected');
                    updateAvailableQuestionsCount();
                });
                container.appendChild(button);
            });
        };

        const startQuiz = () => {
            const selectedThemeElements = document.querySelectorAll('.theme-tag.selected');
            const selectedThemes = Array.from(selectedThemeElements).map(el => el.dataset.theme);

            let filteredQuestions = allQuestions;
            if (selectedThemes.length > 0) {
                filteredQuestions = allQuestions.filter(q =>
                    selectedThemes.some(selectedTheme => q.tema.includes(selectedTheme))
                );
            }

            if (filteredQuestions.length < quizSize) {
                showModal('Poucas Quest√µes', `N√£o h√° quest√µes suficientes (${filteredQuestions.length}) para os temas selecionados. Por favor, escolha outros temas ou um quiz menor.`);
                return;
            }

            quizQuestions = filteredQuestions.sort(() => 0.5 - Math.random()).slice(0, quizSize);

            currentQuestionIndex = 0;
            score = 0;
            correctAnswersCount = 0;

            displayQuestion();
            showScreen('quiz');
        };

        const displayQuestion = () => {
            if (currentQuestionIndex >= quizQuestions.length) {
                showResults();
                return;
            }

            const question = quizQuestions[currentQuestionIndex];
            document.getElementById('question-counter').textContent = `Quest√£o ${currentQuestionIndex + 1} de ${quizQuestions.length}`;
            document.getElementById('current-score').textContent = `Pontos: ${score}`;
            document.getElementById('progress-bar').style.width = `${((currentQuestionIndex) / quizQuestions.length) * 100}%`;

            const questionThemeContainer = document.getElementById('question-theme-container');
            questionThemeContainer.innerHTML = '';
            if (question.tema && question.tema.length > 0) {
                question.tema.forEach(theme => {
                    const themeTag = document.createElement('span');
                    themeTag.className = 'bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full';
                    themeTag.textContent = theme;
                    questionThemeContainer.appendChild(themeTag);
                });
            }

            document.getElementById('question-enunciado').innerHTML = question.enunciado;

            const img = document.getElementById('question-image');
            if (question.imagem_url && question.imagem_url.trim() !== '') {
                img.src = question.imagem_url;
                img.classList.remove('hidden');
                img.onerror = () => { img.classList.add('hidden'); console.warn('Imagem n√£o carregada:', question.imagem_url); };
            } else {
                img.classList.add('hidden');
            }

            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            const options = ['A', 'B', 'C', 'D', 'E'];
            options.forEach(opt => {
                const optionKey = `opcao_${opt}`;
                if (question[optionKey] && question[optionKey].trim() !== '') {
                    const button = document.createElement('button');
                    button.className = 'option-btn w-full text-left p-4 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors';
                    button.innerHTML = `<span class="font-bold mr-2">${opt}.</span> ${question[optionKey]}`;
                    button.dataset.option = opt;
                    button.addEventListener('click', handleOptionClick);
                    optionsContainer.appendChild(button);
                }
            });

            document.getElementById('next-question-btn').classList.add('hidden');
        };

        const handleOptionClick = (event) => {
            const selectedButton = event.currentTarget;
            const selectedOption = selectedButton.dataset.option;
            const question = quizQuestions[currentQuestionIndex];
            const correctOption = question.resposta_correta.trim();

            const allOptionButtons = document.querySelectorAll('.option-btn');
            allOptionButtons.forEach(btn => {
                btn.disabled = true;
                if (btn.dataset.option === correctOption) {
                    btn.classList.add('correct');
                }
            });

            if (selectedOption === correctOption) {
                score += 1;
                correctAnswersCount += 1;
                selectedButton.classList.add('correct');
            } else {
                selectedButton.classList.add('incorrect');
            }

            document.getElementById('current-score').textContent = `Pontos: ${score}`;
            document.getElementById('next-question-btn').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = `${((currentQuestionIndex + 1) / quizQuestions.length) * 100}%`;
        };

        const showResults = async () => {
            let finalScore = score;
            let bonusMessage = '';
            let icon = 'ÔøΩ';

            if (correctAnswersCount === quizSize && quizSize > 0) {
                if (quizSize === 3) {
                    finalScore *= 2;
                    bonusMessage = 'Parab√©ns! Voc√™ acertou todas e seus pontos duplicaram!';
                    icon = 'üéâ';
                } else if (quizSize === 6) {
                    finalScore *= 3;
                    bonusMessage = 'Incr√≠vel! Voc√™ acertou todas e seus pontos triplicaram!';
                    icon = 'üèÜ';
                }
            } else if (correctAnswersCount > quizSize / 2) {
                icon = 'üëç';
            }

            document.getElementById('results-icon').textContent = icon;
            document.getElementById('results-summary').textContent = `Voc√™ acertou ${correctAnswersCount} de ${quizSize} quest√µes.`;
            document.getElementById('results-bonus').textContent = bonusMessage;
            document.getElementById('results-total-score').textContent = `Pontua√ß√£o Final: ${finalScore} pontos`;

            showScreen('results');

            if (auth.currentUser) { // Use auth.currentUser para verificar se h√° um usu√°rio autenticado
                showLoading();
                const userDocRef = doc(db, usersCollectionPath, auth.currentUser.uid); // Usa o UID como ID do documento
                const newTotalScore = (currentUserData?.score || 0) + finalScore; // Usa currentUserData
                try {
                    await updateDoc(userDocRef, { score: newTotalScore });
                    currentUserData.score = newTotalScore; // Atualiza o dado local
                } catch (error) {
                    console.error("Erro ao atualizar pontua√ß√£o:", error);
                    showModal("Erro de Atualiza√ß√£o", `N√£o foi poss√≠vel salvar sua pontua√ß√£o. Detalhes: ${error.message}`);
                } finally {
                    hideLoading();
                }
            }
        };

        const updateRanking = (users) => {
            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = '';

            const sortedUsers = users.sort((a, b) => (b.score || 0) - (a.score || 0));

            if(sortedUsers.length === 0) {
                rankingList.innerHTML = `<p class="p-4 text-center text-gray-500">Nenhum jogador no ranking ainda.</p>`;
                return;
            }

            sortedUsers.forEach((user, index) => {
                const rankItem = document.createElement('div');
                rankItem.className = `grid grid-cols-12 gap-4 p-3 items-center ${user.id === auth.currentUser?.uid ? 'bg-blue-50 font-semibold' : ''}`; // Compara com auth.currentUser?.uid
                rankItem.innerHTML = `
                    <div class="col-span-1">${index + 1}</div>
                    <div class="col-span-7 truncate">${user.name}</div>
                    <div class="col-span-4 text-right">${user.score || 0}</div>
                `;
                rankingList.appendChild(rankItem);
            });
        };

        let rankingUnsubscribe = null;
        const listenToRanking = () => {
            if (rankingUnsubscribe) {
                rankingUnsubscribe();
            }
            rankingUnsubscribe = onSnapshot(usersCollection, (snapshot) => {
                const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateRanking(users);
            }, (error) => {
                console.error("Erro ao carregar ranking:", error);
                document.getElementById('ranking-list').innerHTML = `<p class="p-4 text-center text-red-500">Erro ao carregar o ranking.</p>`;
            });
        };

        const handleRegister = async (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;

            if (!name || !email || !password || !confirmPassword) {
                showModal('Erro de Registro', 'Por favor, preencha todos os campos.');
                return;
            }

            if (password.length < 6) {
                showModal('Senha Fraca', 'A senha deve ter no m√≠nimo 6 caracteres.');
                return;
            }

            if (password !== confirmPassword) {
                showModal('Senhas N√£o Conferem', 'As senhas digitadas n√£o s√£o iguais. Por favor, verifique.');
                return;
            }

            showLoading();

            try {
                // Tenta criar o usu√°rio com email e senha usando Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Salva os dados adicionais do usu√°rio no Firestore, usando o UID como ID do documento
                await setDoc(doc(db, usersCollectionPath, user.uid), {
                    name: name,
                    email: email,
                    score: 0 // Pontua√ß√£o inicial
                });

                hideLoading();
                showModal(
                    'Registro Conclu√≠do!',
                    `Sua conta foi criada com sucesso para ${user.email}! Agora voc√™ pode fazer login.`
                );
                document.getElementById('register-form').reset();
                showScreen('login');

            } catch (error) {
                hideLoading();
                console.error("Erro no registro: ", error);
                let errorMessage = 'Ocorreu um erro ao tentar registrar.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este email j√° est√° em uso. Tente fazer login ou redefinir sua senha.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'O formato do email √© inv√°lido.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'A senha √© muito fraca. Escolha uma senha mais forte.';
                }
                showModal('Erro no Registro', `${errorMessage}<br><br><small>Detalhes: ${error.message}</small>`);
            }
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();

            if (!email || !password) {
                showModal('Erro', 'Por favor, preencha todos os campos.');
                return;
            }

            showLoading();

            try {
                // Tenta fazer login com email e senha usando Firebase Authentication
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Carrega os dados adicionais do usu√°rio do Firestore
                const userDocRef = doc(db, usersCollectionPath, user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    currentUserData = { id: user.uid, ...userDocSnap.data() };
                    document.getElementById('user-name-display').textContent = currentUserData.name.split(' ')[0];
                    hideLoading();
                    showScreen('setup');
                    listenToRanking();
                } else {
                    // Isso n√£o deveria acontecer se o registro funcionar corretamente,
                    // mas √© um fallback caso o documento do usu√°rio n√£o exista no Firestore.
                    console.warn("Documento do usu√°rio n√£o encontrado no Firestore ap√≥s login com Auth. Criando um novo.");
                    currentUserData = { id: user.uid, name: user.email.split('@')[0], email: user.email, score: 0 };
                    await setDoc(userDocRef, currentUserData);
                    document.getElementById('user-name-display').textContent = currentUserData.name.split(' ')[0];
                    hideLoading();
                    showScreen('setup');
                    listenToRanking();
                }
            } catch (error) {
                hideLoading();
                console.error("Erro no login:", error);
                let errorMessage = 'Ocorreu um erro ao tentar fazer login.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Email ou senha incorretos.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'O formato do email √© inv√°lido.';
                }
                showModal('Erro no Login', `${errorMessage}<br><br><small>Detalhes: ${error.message}</small>`);
            }
        };

        const handleForgotPassword = async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value.trim();

            if (!email) {
                showModal('Erro', 'Por favor, insira seu email.');
                return;
            }

            showLoading();

            try {
                // Envia o email de redefini√ß√£o de senha usando Firebase Authentication
                await sendPasswordResetEmail(auth, email);
                showModal(
                    'Link Enviado!',
                    `Um link de redefini√ß√£o de senha foi enviado para <strong class="text-blue-600">${email}</strong>. Por favor, verifique sua caixa de entrada (e spam).`
                );
                document.getElementById('forgot-password-form').reset();
                showScreen('login');
            } catch (error) {
                console.error("Erro ao tentar redefinir senha:", error);
                let errorMessage = 'Ocorreu um erro ao tentar enviar o link de redefini√ß√£o de senha.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'N√£o encontramos uma conta com este email.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'O formato do email √© inv√°lido.';
                }
                showModal('Erro', `${errorMessage}<br><br><small>Detalhes: ${error.message}</small>`);
            } finally {
                hideLoading();
            }
        };

        const handleLogout = async () => {
            showLoading();
            try {
                await signOut(auth);
                currentUserData = null;
                showModal('Sess√£o Encerrada', 'Voc√™ saiu da sua conta.');
                showScreen('login');
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                showModal('Erro ao Sair', `N√£o foi poss√≠vel sair. Detalhes: ${error.message}`);
            } finally {
                hideLoading();
            }
        };


        document.addEventListener('DOMContentLoaded', async () => {
            showLoading();

            if (!window.firebaseConfig || !window.firebaseConfig.apiKey) {
                hideLoading();
                showModal('Erro de Conex√£o', 'Configura√ß√£o do Firebase n√£o encontrada. Recarregue a p√°gina.');
                return;
            }

            // O onAuthStateChanged √© o observador principal do estado de autentica√ß√£o do Firebase.
            // Ele ser√° chamado sempre que o estado de autentica√ß√£o do usu√°rio mudar (login, logout, etc.).
            onAuthStateChanged(auth, async (user) => {
                if(user) {
                    // Usu√°rio autenticado (login, registro bem-sucedido ou sess√£o persistente)
                    console.log("Usu√°rio autenticado via Firebase Auth:", user.uid);
                    
                    // Buscar dados adicionais do usu√°rio no Firestore
                    const userDocRef = doc(db, usersCollectionPath, user.uid);
                    const userDocSnap = await getDoc(userDocRef);

                    if (userDocSnap.exists()) {
                        currentUserData = { id: user.uid, ...userDocSnap.data() };
                        document.getElementById('user-name-display').textContent = currentUserData.name.split(' ')[0];
                        showScreen('setup'); // Redireciona para a tela de configura√ß√£o
                        listenToRanking(); // Come√ßa a escutar o ranking
                    } else {
                        // Se o documento do usu√°rio n√£o existe no Firestore, mas o usu√°rio est√° autenticado no Auth,
                        // isso pode significar um novo registro. Crie o documento no Firestore.
                        console.warn("Documento do usu√°rio n√£o encontrado no Firestore. Criando um novo.");
                        currentUserData = { id: user.uid, name: user.email.split('@')[0], email: user.email, score: 0 };
                        await setDoc(userDocRef, currentUserData);
                        document.getElementById('user-name-display').textContent = currentUserData.name.split('@')[0];
                        showScreen('setup');
                        listenToRanking();
                    }

                } else {
                    // Usu√°rio n√£o autenticado (logout ou nenhuma sess√£o ativa)
                    console.log("Usu√°rio n√£o autenticado. Exibindo tela de login.");
                    currentUserData = null;
                    showScreen('login');
                }
                hideLoading(); // Esconde o spinner de carregamento ap√≥s a verifica√ß√£o inicial do Auth
            });

            fetchQuestions(); // Carrega as perguntas independentemente do estado de autentica√ß√£o inicial

            // Event Listeners para navega√ß√£o entre telas
            document.getElementById('go-to-register-btn').addEventListener('click', () => showScreen('register'));
            document.getElementById('go-to-login-btn').addEventListener('click', () => showScreen('login'));
            document.getElementById('play-again-btn').addEventListener('click', () => showScreen('setup'));
            document.getElementById('back-to-setup-btn').addEventListener('click', () => showScreen('setup'));
            document.getElementById('forgot-password-btn').addEventListener('click', () => showScreen('forgotPassword'));
            document.getElementById('back-to-login-from-forgot-btn').addEventListener('click', () => showScreen('login'));

            // Event Listener para Logout
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            const viewRankingButtons = [
                document.getElementById('view-ranking-btn-setup'),
                document.getElementById('view-ranking-btn-results')
            ];
            viewRankingButtons.forEach(btn => btn.addEventListener('click', () => showScreen('ranking')));

            // Event Listeners para submiss√£o de formul√°rios
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('forgot-password-form').addEventListener('submit', handleForgotPassword);

            document.getElementById('start-quiz-btn').addEventListener('click', startQuiz);

            modalCloseBtn.addEventListener('click', hideModal);

            const quizSizeRulesNotification = document.getElementById('quiz-rules-notification');
            document.getElementById('quiz-size-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('quiz-size-btn') && !e.target.disabled) {
                    document.querySelectorAll('.quiz-size-btn').forEach(btn => {
                        btn.classList.remove('border-blue-500', 'bg-blue-50', 'ring-2');
                        btn.classList.add('border-gray-300');
                    });
                    e.target.classList.add('border-blue-500', 'bg-blue-50', 'ring-2');
                    e.target.classList.remove('border-gray-300');
                    quizSize = parseInt(e.target.dataset.size);

                    quizSizeRulesNotification.classList.remove('hidden');
                    if (quizSize === 3) {
                        quizSizeRulesNotification.innerHTML = 'Para cada pergunta que responder corretamente receber√° um ponto. Caso acerte as tr√™s, <strong>receber√° a pontua√ß√£o em dobro</strong>.';
                    } else if (quizSize === 6) {
                        quizSizeRulesNotification.innerHTML = 'Para cada pergunta que responder corretamente receber√° um ponto. Caso acerte as seis, <strong>receber√° a pontua√ß√£o em triplo</strong>.';
                    }
                    updateAvailableQuestionsCount();
                }
            });

            document.getElementById('next-question-btn').addEventListener('click', () => {
                currentQuestionIndex++;
                displayQuestion();
            });
        }); // Fim de DOMContentLoaded
    </script>
</body>
</html>
