<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz ENADE - Artes Visuais</title>

    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://cdn.tailwindcss.com; object-src 'none'; base-uri 'self';">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .screen { display: none; }
        .active-screen { display: flex; }
        .theme-tag {
            transition: all 0.2s ease-in-out;
        }
        .theme-tag.selected {
            background-color: #10B981; /* green-500 */
            color: white;
            transform: scale(1.05);
        }
        .option-btn.correct {
            background-color: #10B981 !important; /* green-500 */
            color: white !important;
            border-color: #059669 !important;
        }
        .option-btn.incorrect {
            background-color: #EF4444 !important; /* red-500 */
            color: white !important;
            border-color: #DC2626 !important;
        }
        /* Estilo para o bot√£o de cl√£ selecionado */
        .clan-btn.selected {
            background-color: #4F46E5; /* indigo-600 */
            color: white;
            border-color: #4338CA; /* indigo-700 */
            transform: scale(1.05);
        }
        .clan-filter-btn.selected {
            background-color: #4F46E5; /* indigo-600 */
            color: white;
            border-color: #4338CA; /* indigo-700 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center">
        <div class="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <div class="container mx-auto p-4 max-w-2xl w-full">
        <div id="app-container" class="bg-white rounded-xl shadow-lg overflow-hidden">

            <div id="setup-screen" class="screen p-8 md:p-12 flex-col space-y-8 active-screen">
                 <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Ol√°, <span id="user-name-display">Jogador!</span></h2>
                        <p class="text-gray-600">Vamos come√ßar?</p>
                    </div>
                    <div class="flex space-x-2">
                        <button id="view-ranking-btn-setup" class="bg-yellow-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-yellow-600 transition-colors">Ver Ranking</button>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">1. Escolha seu Cl√£</h3>
                    <p class="text-sm text-gray-500 mb-2">Selecione um cl√£ para registrar seus pontos.</p>
                    <div id="clan-container" class="flex flex-wrap gap-2">
                        <button data-clan="Berna Reale" class="clan-btn flex-1 p-4 border-2 border-gray-300 rounded-lg text-lg font-semibold text-gray-700 hover:border-indigo-500 hover:bg-indigo-50 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500">Berna Reale</button>
                        <button data-clan="Denilson Baniwa" class="clan-btn flex-1 p-4 border-2 border-gray-300 rounded-lg text-lg font-semibold text-gray-700 hover:border-indigo-500 hover:bg-indigo-50 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500">Denilson Baniwa</button>
                        <button data-clan="Rosana Paulino" class="clan-btn flex-1 p-4 border-2 border-gray-300 rounded-lg text-lg font-semibold text-gray-700 hover:border-indigo-500 hover:bg-indigo-50 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500">Rosana Paulino</button>
                        <button data-clan="U√Ωra Sodoma" class="clan-btn flex-1 p-4 border-2 border-gray-300 rounded-lg text-lg font-semibold text-gray-700 hover:border-indigo-500 hover:bg-indigo-50 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500">U√Ωra Sodoma</button>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">2. Escolha os temas</h3>
                    <p class="text-sm text-gray-500 mb-2">Selecione um ou mais temas. Se nenhum for escolhido, todas as quest√µes ser√£o consideradas.</p>
                    <div id="themes-container" class="flex flex-wrap gap-2">
                        </div>
                    <p id="question-count-display" class="text-sm text-gray-600 mt-4 text-center font-medium"></p>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">3. Escolha o tamanho do Quiz</h3>
                    <div id="quiz-size-container" class="flex flex-col sm:flex-row gap-4">
                        <button data-size="3" class="quiz-size-btn flex-1 p-4 border-2 border-gray-300 rounded-lg text-lg font-semibold text-gray-700 hover:border-blue-500 hover:bg-blue-50 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:hover:border-gray-300">3 Quest√µes</button>
                        <button data-size="6" class="quiz-size-btn flex-1 p-4 border-2 border-gray-300 rounded-lg text-lg font-semibold text-gray-700 hover:border-blue-500 hover:bg-blue-50 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-100 disabled:hover:border-gray-300">6 Quest√µes</button>
                    </div>
                    <div id="quiz-rules-notification" class="mt-4 p-3 bg-blue-50 text-blue-800 rounded-lg text-center text-sm hidden"></div>
                </div>

                <button id="start-quiz-btn" class="w-full bg-blue-600 text-white p-4 rounded-lg text-xl font-bold hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Iniciar Quiz</button>
            </div>

            <div id="quiz-screen" class="screen p-6 md:p-8 flex-col">
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-sm font-medium text-gray-600 mb-6">
                    <span id="question-counter"></span>
                    <span id="current-score">Pontos: 0</span>
                </div>
                <div id="question-container" class="space-y-4 flex-grow">
                    <div id="question-theme-container" class="flex flex-wrap gap-2 mb-2"></div>
                    <img id="question-image" src="" alt="Imagem da quest√£o" class="max-w-full h-auto mx-auto rounded-lg shadow-md hidden">
                    <h3 id="question-enunciado" class="text-lg md:text-xl font-medium text-gray-800 leading-relaxed"></h3>
                    <div id="options-container" class="grid grid-cols-1 gap-3">
                        </div>
                </div>
                <!-- Bot√£o de confirma√ß√£o adicionado aqui -->
                <button id="confirm-answer-btn" class="mt-6 w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors hidden">Confirmar Resposta</button>
                <button id="next-question-btn" class="mt-6 w-full bg-green-500 text-white p-3 rounded-lg font-semibold hover:bg-green-600 transition-colors hidden">Pr√≥xima Quest√£o</button>
            </div>

            <div id="results-screen" class="screen p-8 md:p-12 flex-col items-center justify-center space-y-6 text-center">
                 <h2 class="text-3xl font-bold text-gray-800">Quiz Finalizado!</h2>
                 <div id="results-icon" class="text-7xl"></div>
                 <p id="results-summary" class="text-xl text-gray-700"></p>
                 <p id="results-bonus" class="text-lg font-semibold text-green-600"></p>
                 <p id="results-total-score" class="text-2xl font-bold text-blue-600"></p>
                 <div class="flex flex-col sm:flex-row gap-4 w-full max-w-sm mt-6">
                     <button id="play-again-btn" class="flex-1 bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Jogar Novamente</button>
                     <button id="view-ranking-btn-results" class="flex-1 bg-yellow-500 text-white p-3 rounded-lg font-semibold hover:bg-yellow-600 transition-colors">Ver Ranking</button>
                 </div>
            </div>

            <div id="ranking-screen" class="screen p-8 md:p-12 flex-col space-y-6">
                <h2 class="text-3xl font-bold text-gray-800 text-center mb-4">Ranking de Cl√£s</h2>
                <!-- Filtros de cl√£ adicionados -->
                <div id="clan-filter-container" class="flex flex-wrap justify-center gap-2 mb-4">
                    <button data-filter-clan="all" class="clan-filter-btn px-3 py-1.5 border border-gray-300 rounded-full text-sm font-medium text-gray-600 hover:bg-gray-100 selected">Todos</button>
                    <button data-filter-clan="Berna Reale" class="clan-filter-btn px-3 py-1.5 border border-gray-300 rounded-full text-sm font-medium text-gray-600 hover:bg-gray-100">Berna Reale</button>
                    <button data-filter-clan="Denilson Baniwa" class="clan-filter-btn px-3 py-1.5 border border-gray-300 rounded-full text-sm font-medium text-gray-600 hover:bg-gray-100">Denilson Baniwa</button>
                    <button data-filter-clan="Rosana Paulino" class="clan-filter-btn px-3 py-1.5 border border-gray-300 rounded-full text-sm font-medium text-gray-600 hover:bg-gray-100">Rosana Paulino</button>
                    <button data-filter-clan="U√Ωra Sodoma" class="clan-filter-btn px-3 py-1.5 border border-gray-300 rounded-full text-sm font-medium text-gray-600 hover:bg-gray-100">U√Ωra Sodoma</button>
                </div>
                <div class="w-full bg-white rounded-lg border">
                    <div class="grid grid-cols-12 gap-4 p-3 border-b bg-gray-50 font-bold text-gray-600">
                        <div class="col-span-1">#</div>
                        <div class="col-span-8">Cl√£</div>
                        <div class="col-span-3 text-right">Pontua√ß√£o</div>
                    </div>
                    <div id="ranking-list" class="divide-y">
                        </div>
                </div>
                <button id="back-to-setup-btn" class="w-full max-w-sm mx-auto bg-gray-600 text-white p-3 rounded-lg font-semibold hover:bg-gray-700 transition-colors">Voltar</button>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center space-y-4">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800"></h3>
            <p id="modal-message" class="text-gray-600"></p>
            <button id="modal-close-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">OK</button>
        </div>
    </div>

    <script src="perguntas.js"></script>
    <script src="firebase-config.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = window.firebaseConfig || {};
        const appId = window.appId || 'default-quiz-app';

        if (!firebaseConfig.apiKey) {
            showModal("Erro", "Erro: Configura√ß√£o do Firebase n√£o encontrada.");
            hideLoading();
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Definindo os cl√£s dispon√≠veis
        const clans = ["Berna Reale", "Denilson Baniwa", "Rosana Paulino", "U√Ωra Sodoma"];
        // Cole√ß√£o para armazenar as pontua√ß√µes dos cl√£s
        const clansCollectionPath = `/artifacts/${appId}/public/data/clans`;
        const clansCollection = collection(db, clansCollectionPath);

        let allQuestions = [];
        let uniqueThemes = [];
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let correctAnswersCount = 0;
        let quizSize = 0;
        let selectedClan = null; // Vari√°vel para armazenar o cl√£ selecionado
        let selectedOptionForConfirmation = null; // Nova vari√°vel para armazenar a op√ß√£o selecionada para confirma√ß√£o

        const screens = {
            setup: document.getElementById('setup-screen'),
            quiz: document.getElementById('quiz-screen'),
            results: document.getElementById('results-screen'),
            ranking: document.getElementById('ranking-screen'),
        };

        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Bot√µes espec√≠ficos do quiz
        const confirmAnswerBtn = document.getElementById('confirm-answer-btn');
        const nextQuestionBtn = document.getElementById('next-question-btn');


        const showScreen = (screenName) => {
            Object.values(screens).forEach(screen => screen.classList.remove('active-screen'));
            if(screens[screenName]) {
                screens[screenName].classList.add('active-screen');
            }
        };

        const showModal = (title, message) => {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message;
            modal.style.display = 'flex';
        };

        const hideModal = () => {
            modal.style.display = 'none';
        };

        const showLoading = () => loadingSpinner.style.display = 'flex';
        const hideLoading = () => loadingSpinner.style.display = 'none';

        // Fun√ß√£o para atualizar o estado do bot√£o "Iniciar Quiz"
        const updateStartQuizButtonState = () => {
            const startQuizBtn = document.getElementById('start-quiz-btn');
            const hasQuizSizeSelected = quizSize > 0;
            const hasClanSelected = selectedClan !== null;
            const hasEnoughQuestions = parseInt(document.getElementById('question-count-display').textContent.split(' ')[0]) >= quizSize;

            // Habilita o bot√£o apenas se o tamanho do quiz, o cl√£ e as quest√µes dispon√≠veis forem v√°lidos
            startQuizBtn.disabled = !(hasQuizSizeSelected && hasClanSelected && hasEnoughQuestions);
        };

        const updateAvailableQuestionsCount = () => {
            const questionCountDisplay = document.getElementById('question-count-display');
            const selectedThemeElements = document.querySelectorAll('.theme-tag.selected');
            const selectedThemes = Array.from(selectedThemeElements).map(el => el.dataset.theme);

            let filteredQuestions = allQuestions;
            if (selectedThemes.length > 0) {
                filteredQuestions = allQuestions.filter(q =>
                    selectedThemes.some(selectedTheme => q.tema.includes(selectedTheme))
                );
            }

            const count = filteredQuestions.length;
            questionCountDisplay.textContent = `${count} quest√µes dispon√≠veis com os temas selecionados.`;

            document.querySelectorAll('.quiz-size-btn').forEach(btn => {
                const size = parseInt(btn.dataset.size);
                btn.disabled = count < size;
            });

            const selectedSizeBtn = document.querySelector('.quiz-size-btn.border-blue-500');
            if (selectedSizeBtn && selectedSizeBtn.disabled) {
                selectedSizeBtn.classList.remove('border-blue-500', 'bg-blue-50', 'ring-2');
                quizSize = 0;
                document.getElementById('quiz-rules-notification').classList.add('hidden');
            }
            updateStartQuizButtonState(); // Atualiza o estado do bot√£o Iniciar Quiz
        };

        const fetchQuestions = () => {
            if (typeof perguntasLocais === 'undefined') {
                console.error("Erro Fatal: 'perguntas.js' n√£o foi carregado.");
                showModal('Erro Cr√≠tico', "O ficheiro de perguntas ('perguntas.js') n√£o foi encontrado ou carregado corretamente.");
                hideLoading();
                return;
            }

            try {
                allQuestions = perguntasLocais
                    .filter(q => q.enunciado && q.resposta_correta && q.tema)
                    .map(q => {
                        const themes = (typeof q.tema === 'string')
                            ? q.tema.split(',').map(t => t.trim())
                            : q.tema;
                        return { ...q, tema: themes.filter(Boolean) };
                    });

                const allThemes = allQuestions.flatMap(q => q.tema);
                uniqueThemes = [...new Set(allThemes)].filter(Boolean).sort();
                populateThemes();
                updateAvailableQuestionsCount();
            } catch (err) {
                 console.error("Erro ao processar 'perguntas.js':", err);
                 showModal('Erro Cr√≠tico', 'Verifique a sintaxe do seu ficheiro `perguntas.js`.');
                 hideLoading();
            }
        };

        const populateThemes = () => {
            const container = document.getElementById('themes-container');
            container.innerHTML = '';
            uniqueThemes.forEach(theme => {
                const button = document.createElement('button');
                button.className = 'theme-tag px-3 py-1.5 border border-gray-300 rounded-full text-sm font-medium text-gray-600 hover:bg-gray-100';
                button.textContent = theme;
                button.dataset.theme = theme;
                button.addEventListener('click', () => {
                    button.classList.toggle('selected');
                    updateAvailableQuestionsCount();
                });
                container.appendChild(button);
            });
        };

        const startQuiz = () => {
            // Verifica se um cl√£ foi selecionado antes de iniciar o quiz
            if (!selectedClan) {
                showModal('Cl√£ N√£o Selecionado', 'Por favor, escolha um cl√£ antes de iniciar o quiz.');
                return;
            }

            const selectedThemeElements = document.querySelectorAll('.theme-tag.selected');
            const selectedThemes = Array.from(selectedThemeElements).map(el => el.dataset.theme);

            let filteredQuestions = allQuestions;
            if (selectedThemes.length > 0) {
                filteredQuestions = allQuestions.filter(q =>
                    selectedThemes.some(selectedTheme => q.tema.includes(selectedTheme))
                );
            }

            if (filteredQuestions.length < quizSize) {
                showModal('Poucas Quest√µes', `N√£o h√° quest√µes suficientes (${filteredQuestions.length}) para os temas selecionados. Por favor, escolha outros temas ou um quiz menor.`);
                return;
            }

            quizQuestions = filteredQuestions.sort(() => 0.5 - Math.random()).slice(0, quizSize);

            currentQuestionIndex = 0;
            score = 0;
            correctAnswersCount = 0;

            displayQuestion();
            showScreen('quiz');
        };

        const displayQuestion = () => {
            if (currentQuestionIndex >= quizQuestions.length) {
                showResults();
                return;
            }

            const question = quizQuestions[currentQuestionIndex];
            document.getElementById('question-counter').textContent = `Quest√£o ${currentQuestionIndex + 1} de ${quizQuestions.length}`;
            document.getElementById('current-score').textContent = `Pontos: ${score}`;
            document.getElementById('progress-bar').style.width = `${((currentQuestionIndex) / quizQuestions.length) * 100}%`;

            const questionThemeContainer = document.getElementById('question-theme-container');
            questionThemeContainer.innerHTML = '';
            if (question.tema && question.tema.length > 0) {
                question.tema.forEach(theme => {
                    const themeTag = document.createElement('span');
                    themeTag.className = 'bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded-full';
                    themeTag.textContent = theme;
                    questionThemeContainer.appendChild(themeTag);
                });
            }

            document.getElementById('question-enunciado').innerHTML = question.enunciado;

            const img = document.getElementById('question-image');
            if (question.imagem_url && question.imagem_url.trim() !== '') {
                img.src = question.imagem_url;
                img.classList.remove('hidden');
                img.onerror = () => { img.classList.add('hidden'); console.warn('Imagem n√£o carregada:', question.imagem_url); };
            } else {
                img.classList.add('hidden');
            }

            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            const options = ['A', 'B', 'C', 'D', 'E'];
            options.forEach(opt => {
                const optionKey = `opcao_${opt}`;
                if (question[optionKey] && question[optionKey].trim() !== '') {
                    const button = document.createElement('button');
                    button.className = 'option-btn w-full text-left p-4 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors';
                    button.innerHTML = `<span class="font-bold mr-2">${opt}.</span> ${question[optionKey]}`;
                    button.dataset.option = opt;
                    button.addEventListener('click', handleOptionSelection); // Alterado para handleOptionSelection
                    optionsContainer.appendChild(button);
                }
            });

            // Esconde os bot√µes de confirma√ß√£o e pr√≥xima quest√£o no in√≠cio de cada pergunta
            confirmAnswerBtn.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');

            // Limpa o estilo de sele√ß√£o e habilita todos os bot√µes de op√ß√£o
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('correct', 'incorrect', 'border-blue-500', 'bg-blue-50', 'ring-2');
                btn.classList.add('border-gray-300'); // Garante que o border padr√£o est√° presente
                btn.disabled = false;
            });

            selectedOptionForConfirmation = null; // Reinicia a op√ß√£o selecionada
        };

        const handleOptionSelection = (event) => {
            const selectedButton = event.currentTarget;

            // Remove a classe 'selected' de qualquer bot√£o de op√ß√£o previamente selecionado
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50', 'ring-2');
                btn.classList.add('border-gray-300'); // Restaura a borda padr√£o
            });

            // Adiciona a classe de sele√ß√£o ao bot√£o clicado
            selectedButton.classList.add('border-blue-500', 'bg-blue-50', 'ring-2');
            selectedButton.classList.remove('border-gray-300'); // Remove a borda padr√£o para a sele√ß√£o

            selectedOptionForConfirmation = selectedButton.dataset.option;
            confirmAnswerBtn.classList.remove('hidden'); // Mostra o bot√£o de confirmar
        };

        const confirmAnswer = () => {
            if (!selectedOptionForConfirmation) {
                showModal('Nenhuma Op√ß√£o Selecionada', 'Por favor, selecione uma op√ß√£o antes de confirmar.');
                return;
            }

            const question = quizQuestions[currentQuestionIndex];
            const correctOption = question.resposta_correta.trim();

            const allOptionButtons = document.querySelectorAll('.option-btn');
            allOptionButtons.forEach(btn => {
                btn.disabled = true; // Desabilita todas as op√ß√µes ap√≥s a confirma√ß√£o
                if (btn.dataset.option === correctOption) {
                    btn.classList.add('correct');
                    btn.classList.remove('border-blue-500', 'bg-blue-50', 'ring-2', 'border-gray-300'); // Garante que o estilo de correto prevale√ßa
                }
            });

            const selectedButton = document.querySelector(`.option-btn[data-option="${selectedOptionForConfirmation}"]`);

            if (selectedOptionForConfirmation === correctOption) {
                score += 1;
                correctAnswersCount += 1;
                selectedButton.classList.add('correct');
                selectedButton.classList.remove('border-blue-500', 'bg-blue-50', 'ring-2', 'border-gray-300');
            } else {
                selectedButton.classList.add('incorrect');
                selectedButton.classList.remove('border-blue-500', 'bg-blue-50', 'ring-2', 'border-gray-300');
            }

            document.getElementById('current-score').textContent = `Pontos: ${score}`;
            confirmAnswerBtn.classList.add('hidden'); // Esconde o bot√£o de confirmar
            nextQuestionBtn.classList.remove('hidden'); // Mostra o bot√£o de pr√≥xima quest√£o
            document.getElementById('progress-bar').style.width = `${((currentQuestionIndex + 1) / quizQuestions.length) * 100}%`;

            selectedOptionForConfirmation = null; // Reinicia a op√ß√£o selecionada para a pr√≥xima pergunta
        };

        const showResults = async () => {
            let finalScore = score;
            let bonusMessage = '';
            let icon = 'ü§î';

            if (correctAnswersCount === quizSize && quizSize > 0) {
                if (quizSize === 3) {
                    finalScore *= 2;
                    bonusMessage = 'Parab√©ns! Voc√™ acertou todas e seus pontos duplicaram!';
                    icon = 'üéâ';
                } else if (quizSize === 6) {
                    finalScore *= 3;
                    bonusMessage = 'Incr√≠vel! Voc√™ acertou todas e seus pontos triplicaram!';
                    icon = 'üèÜ';
                }
            } else if (correctAnswersCount > quizSize / 2) {
                icon = 'üëç';
            }

            document.getElementById('results-icon').textContent = icon;
            document.getElementById('results-summary').textContent = `Voc√™ acertou ${correctAnswersCount} de ${quizSize} quest√µes.`;
            document.getElementById('results-bonus').textContent = bonusMessage;
            document.getElementById('results-total-score').textContent = `Pontua√ß√£o Final: ${finalScore} pontos`;

            showScreen('results');

            if (selectedClan) { // Garante que um cl√£ foi selecionado
                showLoading();
                const clanDocRef = doc(db, clansCollectionPath, selectedClan);
                const clanDocSnap = await getDoc(clanDocRef);
                let currentClanScore = 0;
                
                if (clanDocSnap.exists()) {
                    currentClanScore = clanDocSnap.data().score || 0;
                }

                const newTotalClanScore = currentClanScore + finalScore;
                try {
                    // Atualiza a pontua√ß√£o do cl√£ no Firestore
                    await setDoc(clanDocRef, {
                        name: selectedClan, // O nome do cl√£ √© o ID do documento
                        score: newTotalClanScore
                    }, { merge: true });
                } catch (error) {
                    console.error("Erro ao atualizar pontua√ß√£o do cl√£:", error);
                    showModal("Erro de Atualiza√ß√£o", `N√£o foi poss√≠vel salvar a pontua√ß√£o do cl√£. Detalhes: ${error.message}`);
                } finally {
                    hideLoading();
                }
            } else {
                showModal("Cl√£ Ausente", "Sua pontua√ß√£o n√£o foi salva no ranking porque nenhum cl√£ foi selecionado.");
            }
        };

        const updateRanking = (clansData, filterClan = 'all') => {
            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = '';

            let filteredClans = clansData;
            if (filterClan !== 'all') {
                filteredClans = clansData.filter(clan => clan.name === filterClan);
            }

            const sortedClans = filteredClans.sort((a, b) => (b.score || 0) - (a.score || 0));

            if(sortedClans.length === 0) {
                rankingList.innerHTML = `<p class="p-4 text-center text-gray-500">Nenhum cl√£ no ranking ainda.</p>`;
                return;
            }

            sortedClans.forEach((clan, index) => {
                const rankItem = document.createElement('div');
                rankItem.className = `grid grid-cols-12 gap-4 p-3 items-center`; // Remover estiliza√ß√£o espec√≠fica de "currentUser"
                rankItem.innerHTML = `
                    <div class="col-span-1">${index + 1}</div>
                    <div class="col-span-8 truncate">${clan.name}</div>
                    <div class="col-span-3 text-right">${clan.score || 0}</div>
                `;
                rankingList.appendChild(rankItem);
            });
        };

        let rankingUnsubscribe = null;
        const listenToRanking = (filterClan = 'all') => {
            if (rankingUnsubscribe) {
                rankingUnsubscribe();
            }
            // Listener que busca todos os documentos da cole√ß√£o de cl√£s
            rankingUnsubscribe = onSnapshot(clansCollection, (snapshot) => {
                const clansData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateRanking(clansData, filterClan); // Passa o filtro atual para updateRanking
            }, (error) => {
                console.error("Erro ao carregar ranking de cl√£s:", error);
                document.getElementById('ranking-list').innerHTML = `<p class="p-4 text-center text-red-500">Erro ao carregar o ranking de cl√£s.</p>`;
            });
        };

        document.addEventListener('DOMContentLoaded', async () => {
            showLoading();

            if (!window.firebaseConfig || !window.firebaseConfig.apiKey) {
                hideLoading();
                showModal('Erro de Conex√£o', 'Configura√ß√£o do Firebase n√£o encontrada. Recarregue a p√°gina.');
                return;
            }

            try {
                // Autentica√ß√£o an√¥nima para permitir acesso ao Firestore
                await signInAnonymously(auth);

                // Inicializa os documentos dos cl√£s no Firestore se n√£o existirem
                for (const clanName of clans) {
                    const clanDocRef = doc(db, clansCollectionPath, clanName);
                    const clanDocSnap = await getDoc(clanDocRef);
                    if (!clanDocSnap.exists()) {
                        await setDoc(clanDocRef, { name: clanName, score: 0 });
                    }
                }
            } catch (error) {
                console.error("Firebase Auth/Firestore Error:", error);
                showModal('Erro de Conex√£o', `N√£o foi poss√≠vel inicializar o aplicativo. Detalhes: ${error.message}`);
                hideLoading();
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if(user) {
                    console.log("Usu√°rio autenticado anonimamente:", user.uid);
                    document.getElementById('user-name-display').textContent = "Jogador An√¥nimo!";
                    
                    fetchQuestions();
                    listenToRanking(); // Inicia o listener de ranking com filtro 'all' por padr√£o
                    showScreen('setup');
                } else {
                    console.log("Nenhum usu√°rio logado. Isso n√£o deveria acontecer ap√≥s signInAnonymously.");
                    showModal('Erro de Autentica√ß√£o', 'N√£o foi poss√≠vel autenticar anonimamente. Por favor, recarregue a p√°gina.');
                }
                hideLoading();
            });

            // Event Listeners para navega√ß√£o entre telas
            document.getElementById('play-again-btn').addEventListener('click', () => showScreen('setup'));
            document.getElementById('back-to-setup-btn').addEventListener('click', () => showScreen('setup'));
            
            const viewRankingButtons = [
                document.getElementById('view-ranking-btn-setup'),
                document.getElementById('view-ranking-btn-results')
            ];
            viewRankingButtons.forEach(btn => btn.addEventListener('click', () => {
                showScreen('ranking');
                // Garante que o ranking √© atualizado quando a tela √© exibida,
                // mantendo o filtro ativo ou mostrando todos se nenhum filtro estiver ativo.
                const currentFilterBtn = document.querySelector('#clan-filter-container .clan-filter-btn.selected');
                const filterClan = currentFilterBtn ? currentFilterBtn.dataset.filterClan : 'all';
                listenToRanking(filterClan);
            }));

            document.getElementById('start-quiz-btn').addEventListener('click', startQuiz);
            modalCloseBtn.addEventListener('click', hideModal);

            // Event listener para sele√ß√£o de cl√£
            document.getElementById('clan-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('clan-btn')) {
                    document.querySelectorAll('.clan-btn').forEach(btn => {
                        btn.classList.remove('selected');
                        btn.classList.add('border-gray-300', 'text-gray-700', 'hover:border-indigo-500', 'hover:bg-indigo-50', 'focus:ring-indigo-500');
                    });
                    e.target.classList.add('selected');
                    e.target.classList.remove('border-gray-300', 'text-gray-700', 'hover:border-indigo-500', 'hover:bg-indigo-50', 'focus:ring-indigo-500');
                    selectedClan = e.target.dataset.clan;
                    updateStartQuizButtonState(); // Atualiza o estado do bot√£o Iniciar Quiz
                }
            });

            const quizSizeRulesNotification = document.getElementById('quiz-rules-notification');
            document.getElementById('quiz-size-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('quiz-size-btn') && !e.target.disabled) {
                    document.querySelectorAll('.quiz-size-btn').forEach(btn => {
                        btn.classList.remove('border-blue-500', 'bg-blue-50', 'ring-2');
                        btn.classList.add('border-gray-300');
                    });
                    e.target.classList.add('border-blue-500', 'bg-blue-50', 'ring-2');
                    e.target.classList.remove('border-gray-300');
                    quizSize = parseInt(e.target.dataset.size);

                    quizSizeRulesNotification.classList.remove('hidden');
                    if (quizSize === 3) {
                        quizSizeRulesNotification.innerHTML = 'Para cada pergunta que responder corretamente seu cl√£ receber√° um ponto. Caso acerte as tr√™s, <strong>receber√° a pontua√ß√£o em dobro</strong>.';
                    } else if (quizSize === 6) {
                        quizSizeRulesNotification.innerHTML = 'Para cada pergunta que responder corretamente seu cl√£ receber√° um ponto. Caso acerte as seis, <strong>receber√° a pontua√ß√£o em triplo</strong>.';
                    }
                    updateAvailableQuestionsCount(); // Chama para garantir que o bot√£o "Iniciar Quiz" seja habilitado/desabilitado corretamente
                }
            });

            // Event listener para filtrar o ranking por cl√£
            document.getElementById('clan-filter-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('clan-filter-btn')) {
                    document.querySelectorAll('.clan-filter-btn').forEach(btn => {
                        btn.classList.remove('selected');
                        btn.classList.add('border-gray-300', 'text-gray-600', 'hover:bg-gray-100');
                    });
                    e.target.classList.add('selected');
                    e.target.classList.remove('border-gray-300', 'text-gray-600', 'hover:bg-gray-100');
                    const filterClan = e.target.dataset.filterClan;
                    listenToRanking(filterClan); // Atualiza o ranking com o filtro selecionado
                }
            });

            // Adiciona o event listener para o novo bot√£o de confirmar resposta
            confirmAnswerBtn.addEventListener('click', confirmAnswer);

            nextQuestionBtn.addEventListener('click', () => {
                currentQuestionIndex++;
                displayQuestion();
            });
        }); // Fim de DOMContentLoaded
    </script>
</body>
</html>
