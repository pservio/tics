<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - ENADE (Corrigido)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 30px; border-radius: 10px; max-width: 500px; margin: auto; position: relative; }
        .close-button { position: absolute; top: 10px; right: 20px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover { color: #000; }
        .debug-info { background: #f0f0f0; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; margin: 10px 0; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-8">Painel Administrativo - ENADE (Corrigido)</h1>
            
            <!-- Status do Firebase -->
            <div id="firebase-status" class="mb-6 p-4 bg-blue-100 rounded-lg">
                <h3 class="font-semibold text-blue-800 mb-2">Status do Firebase:</h3>
                <div id="firebase-info" class="text-sm text-blue-700">Verificando...</div>
            </div>

            <!-- Login do Admin -->
            <div id="admin-login" class="mb-8">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Login Administrativo</h2>
                <div class="flex gap-4 items-end">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="admin-email" class="border border-gray-300 rounded-lg px-4 py-2 w-64" placeholder="admin@exemplo.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                        <input type="password" id="admin-password" class="border border-gray-300 rounded-lg px-4 py-2 w-64" placeholder="Senha">
                    </div>
                    <button id="admin-login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">
                        Entrar
                    </button>
                </div>
                <div id="login-status" class="mt-2 text-sm"></div>
            </div>

            <!-- Painel Principal (oculto at√© login) -->
            <div id="admin-panel" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-700">Gerenciamento de Alunos</h2>
                    <div class="flex gap-4">
                        <a href="reports-panel.html" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">
                            üìä Relat√≥rios
                        </a>
                        <a href="editor-perguntas.html" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">
                            ‚úèÔ∏è Editor de Perguntas
                        </a>
                        <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                            Sair
                        </button>
                    </div>
                </div>

                <!-- Formul√°rio de Cadastro -->
                <div class="bg-gray-50 p-6 rounded-lg mb-8">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Cadastrar Novo Aluno</h3>
                    
                    <!-- Verifica√ß√£o de Usu√°rios √ìrf√£os -->
                    <div class="mb-4 p-4 bg-yellow-50 rounded-lg">
                        <h4 class="text-sm font-medium text-yellow-800 mb-2">üîç Verificar usu√°rios √≥rf√£os no Firebase Auth</h4>
                        <div class="flex gap-2">
                            <input type="email" id="orphan-email" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="Digite o email para verificar">
                            <button type="button" id="check-orphan-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg text-sm">
                                Verificar
                            </button>
                        </div>
                        <div id="orphan-result" class="mt-2 text-sm"></div>
                    </div>
                    
                    <form id="student-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                            <input type="text" id="student-name" required class="border border-gray-300 rounded-lg px-4 py-2 w-full" placeholder="Nome do aluno">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="student-email" required class="border border-gray-300 rounded-lg px-4 py-2 w-full" placeholder="email@exemplo.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                            <input type="password" id="student-password" required class="border border-gray-300 rounded-lg px-4 py-2 w-full" placeholder="Senha">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ano de Inscri√ß√£o</label>
                            <input type="text" id="student-year" required class="border border-gray-300 rounded-lg px-4 py-2 w-full" placeholder="aaaa (ex: 2024)" maxlength="4" pattern="[0-9]{4}" title="Digite um ano v√°lido com 4 d√≠gitos">
                            <div id="year-error" class="text-red-600 text-xs mt-1 hidden">Digite um ano v√°lido com 4 d√≠gitos (ex: 2024)</div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="student-status" required class="border border-gray-300 rounded-lg px-4 py-2 w-full">
                                <option value="active">Ativo</option>
                                <option value="inactive">Inativo</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">
                                Cadastrar Aluno
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Lista de Alunos -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-semibold text-gray-700">Alunos Cadastrados</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ano</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="students-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Dados ser√£o inseridos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Debug Console -->
            <div id="debug-console" class="mt-8 p-4 bg-gray-900 text-green-400 rounded-lg">
                <h3 class="font-semibold mb-2">Debug Console:</h3>
                <div id="debug-output" class="text-xs font-mono max-h-40 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-modal">&times;</span>
            <h3 id="modal-title" class="text-lg font-semibold mb-4"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="modal-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">
                    Cancelar
                </button>
                <button id="modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCVQ83EIzNpL5ppuxTH1TSUOd0T2G-9KcQ",
            authDomain: "desafioenade2.firebaseapp.com",
            projectId: "desafioenade2",
            storageBucket: "desafioenade2.appspot.com",
            messagingSenderId: "987973574127",
            appId: "1:987973574127:web:4041110632500dbd482a1a",
            measurementId: "G-FD8E45DWKR"
        };

        // Debug function
        function debugLog(message, type = 'info') {
            const debugOutput = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-yellow-400';
            
            debugOutput.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        // Inicializar Firebase
        debugLog('Iniciando configura√ß√£o do Firebase...');
        
        let app, auth, db;
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            // Configurar persist√™ncia local para manter sess√£o
            setPersistence(auth, browserLocalPersistence);
            
            debugLog('Firebase inicializado com sucesso', 'success');
            
            // Atualizar status do Firebase
            document.getElementById('firebase-info').innerHTML = `
                <div class="text-green-600">‚úÖ Firebase conectado</div>
                <div class="text-xs mt-1">Project ID: ${firebaseConfig.projectId}</div>
            `;
        } catch (error) {
            debugLog(`Erro ao inicializar Firebase: ${error.message}`, 'error');
            document.getElementById('firebase-info').innerHTML = `
                <div class="text-red-600">‚ùå Erro no Firebase: ${error.message}</div>
            `;
        }

        // Elementos DOM
        const adminLogin = document.getElementById('admin-login');
        const adminPanel = document.getElementById('admin-panel');
        const adminEmail = document.getElementById('admin-email');
        const adminPassword = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const loginStatus = document.getElementById('login-status');
        const logoutBtn = document.getElementById('logout-btn');
        const studentForm = document.getElementById('student-form');
        const studentsTableBody = document.getElementById('students-table-body');
        const confirmModal = document.getElementById('confirm-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');
        const closeModal = document.getElementById('close-modal');
        const orphanEmail = document.getElementById('orphan-email');
        const checkOrphanBtn = document.getElementById('check-orphan-btn');
        const orphanResult = document.getElementById('orphan-result');

        let currentAdmin = null;

        // Valida√ß√£o do campo de ano
        const yearInput = document.getElementById('student-year');
        const yearError = document.getElementById('year-error');

        // Permitir apenas n√∫meros
        yearInput.addEventListener('input', function(e) {
            // Remove caracteres n√£o num√©ricos
            this.value = this.value.replace(/[^0-9]/g, '');
            
            // Limita a 4 d√≠gitos
            if (this.value.length > 4) {
                this.value = this.value.slice(0, 4);
            }
            
            // Valida√ß√£o do ano
            validateYear();
        });

        // Valida√ß√£o do ano
        function validateYear() {
            const year = yearInput.value;
            const currentYear = new Date().getFullYear();
            
            if (year.length === 4) {
                const yearNum = parseInt(year);
                if (yearNum >= 1900 && yearNum <= currentYear + 1) {
                    yearInput.classList.remove('border-red-500');
                    yearInput.classList.add('border-gray-300');
                    yearError.classList.add('hidden');
                    return true;
                } else {
                    yearInput.classList.remove('border-gray-300');
                    yearInput.classList.add('border-red-500');
                    yearError.classList.remove('hidden');
                    return false;
                }
            } else {
                yearInput.classList.remove('border-red-500');
                yearInput.classList.add('border-gray-300');
                yearError.classList.add('hidden');
                return false;
            }
        }

        // Verificar se o usu√°rio j√° est√° logado
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                debugLog(`Usu√°rio autenticado: ${user.email}`);
                
                // Renovar token automaticamente para evitar expira√ß√£o
                try {
                    await user.getIdToken(true);
                    debugLog('Token renovado automaticamente', 'success');
                } catch (error) {
                    debugLog(`Erro ao renovar token: ${error.message}`, 'error');
                }
                
                // Verificar se √© admin
                checkIfAdmin(user.uid);
            } else {
                debugLog('Nenhum usu√°rio autenticado');
                showLoginForm();
            }
        });

        // Login do admin
        adminLoginBtn.addEventListener('click', async () => {
            const email = adminEmail.value;
            const password = adminPassword.value;

            if (!email || !password) {
                showMessage('Por favor, preencha todos os campos.', 'error');
                return;
            }

            try {
                debugLog(`Tentando login com: ${email}`);
                adminLoginBtn.disabled = true;
                adminLoginBtn.textContent = 'Entrando...';
                
                await signInWithEmailAndPassword(auth, email, password);
                debugLog('Login realizado com sucesso', 'success');
                showMessage('Login realizado com sucesso!', 'success');
            } catch (error) {
                debugLog(`Erro no login: ${error.code} - ${error.message}`, 'error');
                showMessage(`Erro no login: ${error.message}`, 'error');
            } finally {
                adminLoginBtn.disabled = false;
                adminLoginBtn.textContent = 'Entrar';
            }
        });

        // Adicione esta fun√ß√£o de debug tempor√°ria
        async function debugAdminCheck(uid) {
            try {
                debugLog(`üîç Debug - Procurando admin com UID: ${uid}`);
                
                const adminQuery = query(collection(db, "admins"), where("uid", "==", uid));
                const adminSnapshot = await getDocs(adminQuery);
                
                debugLog(`üîç Debug - Documentos encontrados: ${adminSnapshot.size}`);
                
                adminSnapshot.forEach(doc => {
                    debugLog(`üîç Debug - Documento admin: ${doc.id} - ${JSON.stringify(doc.data())}`);
                });
                
                return !adminSnapshot.empty;
            } catch (error) {
                debugLog(`üîç Debug - Erro ao verificar admin: ${error.message}`, 'error');
                return false;
            }
        }

        // Modifique a fun√ß√£o checkIfAdmin para usar debug
        async function checkIfAdmin(uid) {
            try {
                debugLog(`Verificando se ${uid} √© admin...`);
                const isAdmin = await debugAdminCheck(uid);
                
                if (isAdmin) {
                    debugLog('Usu√°rio √© admin, mostrando painel', 'success');
                    currentAdmin = uid;
                    showAdminPanel();
                    loadStudents();
                } else {
                    debugLog('Usu√°rio n√£o √© admin', 'error');
                    showMessage('Acesso negado. Apenas administradores podem acessar este painel.', 'error');
                    await signOut(auth);
                }
            } catch (error) {
                debugLog(`Erro ao verificar permiss√µes: ${error.message}`, 'error');
                showMessage(`Erro ao verificar permiss√µes: ${error.message}`, 'error');
            }
        }

        // Mostrar formul√°rio de login
        function showLoginForm() {
            adminLogin.classList.remove('hidden');
            adminPanel.classList.add('hidden');
            currentAdmin = null;
        }

        // Mostrar painel admin
        function showAdminPanel() {
            adminLogin.classList.add('hidden');
            adminPanel.classList.remove('hidden');
        }

        // Logout
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                debugLog('Logout realizado', 'success');
                showMessage('Logout realizado com sucesso!', 'success');
            } catch (error) {
                debugLog(`Erro no logout: ${error.message}`, 'error');
                showMessage(`Erro no logout: ${error.message}`, 'error');
            }
        });

        // Cadastrar aluno
        studentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('student-name').value;
            const email = document.getElementById('student-email').value;
            const password = document.getElementById('student-password').value;
            const year = document.getElementById('student-year').value;
            const status = document.getElementById('student-status').value;

            if (!name || !email || !password || !year) {
                showMessage('Por favor, preencha todos os campos obrigat√≥rios.', 'error');
                return;
            }

            // Validar formato do ano
            if (!validateYear()) {
                showMessage('Por favor, digite um ano v√°lido com 4 d√≠gitos (ex: 2024).', 'error');
                yearInput.focus();
                return;
            }

            try {
                debugLog(`Tentando criar aluno: ${email}`);
                
                // Criar usu√°rio no Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;
                
                debugLog(`Usu√°rio criado no Auth: ${uid}`, 'success');

                // Salvar dados do aluno no Firestore
                const studentData = {
                    uid: uid,
                    name: name,
                    email: email,
                    year: year,
                    status: status,
                    createdAt: new Date(),
                    createdBy: currentAdmin
                };
                
                debugLog('Salvando dados no Firestore...');
                await addDoc(collection(db, "students"), studentData);
                
                debugLog('Aluno cadastrado com sucesso!', 'success');
                showMessage('Aluno cadastrado com sucesso!', 'success');
                studentForm.reset();
                loadStudents();
                
            } catch (error) {
                debugLog(`Erro ao cadastrar aluno: ${error.code} - ${error.message}`, 'error');
                
                let errorMessage = 'Erro ao cadastrar aluno.';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Este email j√° est√° em uso.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Email inv√°lido.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'A senha √© muito fraca (m√≠nimo 6 caracteres).';
                        break;
                    case 'auth/operation-not-allowed':
                        errorMessage = 'Autentica√ß√£o por email/senha n√£o est√° habilitada no Firebase.';
                        break;
                    default:
                        errorMessage = `Erro: ${error.message}`;
                }
                
                showMessage(errorMessage, 'error');
            }
        });

        // Carregar lista de alunos
        async function loadStudents() {
            try {
                debugLog('Carregando lista de alunos...');
                const studentsSnapshot = await getDocs(collection(db, "students"));
                studentsTableBody.innerHTML = '';

                debugLog(`Encontrados ${studentsSnapshot.size} alunos`);
                
                if (studentsSnapshot.size === 0) {
                    debugLog('Nenhum aluno encontrado no Firestore', 'error');
                    studentsTableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                Nenhum aluno cadastrado. Verifique se h√° usu√°rios √≥rf√£os no Firebase Auth.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                studentsSnapshot.forEach((doc) => {
                    const student = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.year}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${student.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${student.status === 'active' ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editStudent('${doc.id}')" class="text-blue-600 hover:text-blue-900 mr-3">Editar</button>
                            <button onclick="deleteStudent('${doc.id}', '${student.name}')" class="text-red-600 hover:text-red-900">Excluir</button>
                        </td>
                    `;
                    studentsTableBody.appendChild(row);
                });
                
                debugLog('Lista de alunos carregada com sucesso', 'success');
            } catch (error) {
                debugLog(`Erro ao carregar alunos: ${error.message}`, 'error');
                showMessage(`Erro ao carregar alunos: ${error.message}`, 'error');
            }
        }

        // Excluir aluno
        window.deleteStudent = async (docId, studentName) => {
            showConfirmModal(
                'Confirmar Exclus√£o',
                `Tem certeza que deseja excluir o aluno "${studentName}"? Esta a√ß√£o n√£o pode ser desfeita.`,
                async () => {
                    try {
                        debugLog(`Excluindo aluno: ${studentName}`);
                        await deleteDoc(doc(db, "students", docId));
                        debugLog('Aluno exclu√≠do com sucesso', 'success');
                        showMessage('Aluno exclu√≠do com sucesso!', 'success');
                        loadStudents();
                    } catch (error) {
                        debugLog(`Erro ao excluir aluno: ${error.message}`, 'error');
                        showMessage(`Erro ao excluir aluno: ${error.message}`, 'error');
                    }
                }
            );
        };

        // Editar aluno (placeholder)
        window.editStudent = (docId) => {
            showMessage('Funcionalidade de edi√ß√£o ser√° implementada em breve.', 'info');
        };

        // Modal de confirma√ß√£o
        function showConfirmModal(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            confirmModal.style.display = 'flex';
            
            modalConfirm.onclick = () => {
                confirmModal.style.display = 'none';
                onConfirm();
            };
            
            modalCancel.onclick = () => {
                confirmModal.style.display = 'none';
            };
            
            closeModal.onclick = () => {
                confirmModal.style.display = 'none';
            };
        }

        // Mostrar mensagens
        function showMessage(message, type = 'info') {
            const colors = {
                success: 'text-green-700 bg-green-100 border-green-400',
                error: 'text-red-700 bg-red-100 border-red-400',
                info: 'text-blue-700 bg-blue-100 border-blue-400'
            };
            
            loginStatus.innerHTML = `
                <div class="border px-4 py-3 rounded ${colors[type]}">
                    ${message}
                </div>
            `;
            
            setTimeout(() => {
                loginStatus.innerHTML = '';
            }, 5000);
        }

        // Fechar modal ao clicar fora
        window.onclick = (event) => {
            if (event.target === confirmModal) {
                confirmModal.style.display = 'none';
            }
        };

        // Verificar usu√°rios √≥rf√£os no Firebase Auth
        checkOrphanBtn.addEventListener('click', async () => {
            const email = orphanEmail.value.trim();
            if (!email) {
                orphanResult.innerHTML = '<div class="text-red-600">Digite um email para verificar.</div>';
                return;
            }

            try {
                debugLog(`Verificando usu√°rio √≥rf√£o: ${email}`);
                orphanResult.innerHTML = '<div class="text-blue-600">Verificando...</div>';
                
                // Verificar se existe no Firestore
                const studentQuery = query(collection(db, "students"), where("email", "==", email));
                const studentSnapshot = await getDocs(studentQuery);
                
                let resultHTML = '';
                
                if (!studentSnapshot.empty) {
                    const student = studentSnapshot.docs[0].data();
                    resultHTML = `
                        <div class="text-green-600 font-medium">‚úÖ Usu√°rio encontrado no Firestore</div>
                        <div class="text-gray-700 mt-1">
                            <strong>Nome:</strong> ${student.name}<br>
                            <strong>Email:</strong> ${student.email}<br>
                            <strong>Ano:</strong> ${student.year}<br>
                            <strong>Status:</strong> ${student.status === 'active' ? 'Ativo' : 'Inativo'}<br>
                            <strong>UID:</strong> ${student.uid}
                        </div>
                    `;
                } else {
                    resultHTML = `
                        <div class="text-red-600 font-medium">‚ö†Ô∏è Usu√°rio N√ÉO encontrado no Firestore</div>
                        <div class="text-gray-700 mt-1">
                            Este email pode estar no Firebase Auth mas n√£o no Firestore.<br>
                            <button onclick="recoverOrphanUser('${email}')" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-xs">
                                Tentar Recuperar
                            </button>
                        </div>
                    `;
                }
                
                orphanResult.innerHTML = resultHTML;
                debugLog(`Verifica√ß√£o conclu√≠da para: ${email}`, 'success');
            } catch (error) {
                debugLog(`Erro ao verificar usu√°rio √≥rf√£o: ${error.message}`, 'error');
                orphanResult.innerHTML = `<div class="text-red-600">Erro ao verificar: ${error.message}</div>`;
            }
        });

        // Recuperar usu√°rio √≥rf√£o
        window.recoverOrphanUser = async (email) => {
            try {
                debugLog(`Tentando recuperar usu√°rio √≥rf√£o: ${email}`);
                
                // Aqui voc√™ pode implementar a l√≥gica para recuperar o usu√°rio
                // Por exemplo, criar um registro no Firestore com dados b√°sicos
                
                showMessage(`Funcionalidade de recupera√ß√£o ser√° implementada. Email: ${email}`, 'info');
                
            } catch (error) {
                debugLog(`Erro ao recuperar usu√°rio √≥rf√£o: ${error.message}`, 'error');
                showMessage(`Erro ao recuperar usu√°rio: ${error.message}`, 'error');
            }
        };

        // Buscar ao pressionar Enter no campo de verifica√ß√£o
        orphanEmail.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                checkOrphanBtn.click();
            }
        });

        debugLog('Sistema inicializado e pronto', 'success');
    </script>
</body>
</html> 
